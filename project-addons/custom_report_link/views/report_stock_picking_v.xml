<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_picking_custom_data_v">
        <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="custom_report_link.external_layout_custom_picking_v">
                         <!-- Calcular la divisa del widget para tener en cuenta casos en los que es null y que no dé error al general el informe -->
                         <t t-set="monetary_widget" t-value="o.sale_id.pricelist_id.currency_id.id"/>
                         <t t-if="monetary_widget">
                            <t t-set="monetary_widget" t-value="o.sale_id.pricelist_id.currency_id"/>
                         </t>
                         <t t-if="not monetary_widget">
                            <t t-set="monetary_widget" t-value="o.partner_id.eur_currency"/>
                         </t>
                        <div class="page" t-if="o.partner_id.parent_id.valued_picking == True and o.partner_id.valued_picking == True and o.partner_id.valued_picking == True and o.picking_type_id.code == 'outgoing' and o.has_packs == False">
                            <div class="row">
                                <table class="table table-condensed" style="font-size:12px; margin-top: 5%;">
                                    <thead>
                                      <tr style="background-color:#A61D34; color:white;">
                                          <th width="15%" style="vertical-align:middle;"><strong>Reference</strong></th>
                                          <th width="40%" style="vertical-align:middle;"><strong>Description</strong></th>
                                          <th width="7%" class="text-center" style="vertical-align:middle;"><strong>Quantity</strong></th>
                                          <th width="10%" class="text-center" style="vertical-align:middle;"><strong>Unit Price</strong></th>
                                          <th width="8%" class="text-center" style="vertical-align:middle;"><strong>Discount</strong></th>
                                          <th width="10%" class="text-center" style="vertical-align:middle;"><strong>Unit Cost</strong></th>
                                          <th width="10%" class="text-center" style="vertical-align:middle;"><strong>Amount</strong></th>
                                      </tr>
                                    </thead>
                                    <tbody style="color:6D6E70;">
                                        <t t-set="last_pack" t-value="empty"/>
                                        <t t-set="controller" t-value="0"/>
                                        <t t-set="total_price" t-value="0"/>
                                        <t t-set="total_tax" t-value="0"/>
                                          <t t-foreach="o.move_lines" t-as="move">
                                              <t t-if="move.sale_line_id.pack_components is True">
                                                  <t t-set="current_total_price" t-value="(move.procurement_id.sale_line_id.pack_parent_line_id.price_unit*(1-(move.procurement_id.sale_line_id.pack_parent_line_id.discount/100)))*move.procurement_id.sale_line_id.pack_parent_line_id.product_uom_qty"/>
                                                  <t t-set="total_price" t-value="total_price + current_total_price"/>
                                                  <t t-set="product_tax" t-value="move.procurement_id.sale_line_id.tax_id.amount"/>
                                                  <t t-set="total_tax" t-value="total_tax + (product_tax * current_total_price)"/>
                                                  <tr>
                                                      <tr t-if="last_pack != move.sale_line_id.pack_components">
                                                          <t t-set="last_pack" t-value="move.procurement_id.sale_line_id.pack_parent_line_id.product_id"/>
                                                          <t t-set="qty" t-value="move.procurement_id.sale_line_id.pack_parent_line_id.product_uom_qty"/>
                                                          <td colspan="2" style="font-size:14px; font-weight: bold; color:#6D6E70;">Pack: <strong t-field="move.procurement_id.sale_line_id.pack_parent_line_id.product_id"/> (<strong t-esc="'%.0f' %  qty"/>)</td>
                                                          <!--<t t-if="move.procurement_id.sale_line_id.discount == float(0)">
                                                              <td class="text-center"><span t-esc="move.order_price_unit"/></td>
                                                          </t>
                                                          <t t-if="move.procurement_id.sale_line_id.discount != float(0)">
                                                              <td class="text-center"><span t-esc="move.order_price_unit/(move.procurement_id.sale_line_id.discount/100)"/></td>
                                                          </t>-->
                                                          <td class="text-center"></td>
                                                          <td class="text-center"></td>
                                                          <td class="text-center"></td>
                                                          <td class="text-center"></td>
                                                          <td class="text-center"></td>
                                                      </tr>
                                                      <!--<t t-set="current_total_price" t-value=t-esc="(move.procurement_id.sale_line_id.pack_parent_line_id.price_unit*(1-(move.procurement_id.sale_line_id.pack_parent_line_id.discount/100)))*move.procurement_id.sale_line_id.pack_parent_line_id.product_uom_qty"/>
                                                      <t t-set="total_price" t-value="total_price + current_total_price"/>-->
                                                      <td><span t-field="move.product_id"/></td>
                                                      <td style="font-size:10px"><span t-field="move.product_id.product_tmpl_id.description_sale"/></td>
                                                      <td class="text-center"><span t-esc="'%.0f'% move.product_uom_qty"/></td>
                                                      <td class="text-center"><span t-field="move.procurement_id.sale_line_id.pack_parent_line_id.price_unit"
                                                                                    t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;monetary_widget&quot;}"/></td>
                                                      <td class="text-center"><span t-esc="'%.1f'% move.procurement_id.sale_line_id.pack_parent_line_id.discount"/> %</td>
                                                      <td class="text-center"><span t-esc="(move.procurement_id.sale_line_id.pack_parent_line_id.price_unit*(1-(move.procurement_id.sale_line_id.pack_parent_line_id.discount/100)))"
                                                                                    t-esc-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;monetary_widget&quot;}"/></td>
                                                      <td class="text-center"><span t-esc="(move.procurement_id.sale_line_id.pack_parent_line_id.price_unit*(1-(move.procurement_id.sale_line_id.pack_parent_line_id.discount/100)))*move.procurement_id.sale_line_id.pack_parent_line_id.product_uom_qty"
                                                                                    t-esc-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;monetary_widget&quot;}"/></td>
                                                  </tr>
                                              </t>
                                          </t>
                                          <tr t-foreach="o.move_lines" t-as="move">
                                              <t t-if="move.sale_line_id.pack_components is False">
                                                  <tr t-if="controller == 0">
                                                      <t t-set="controller" t-value="1"/>
                                                      <td colspan="2" style="font-size:14px; font-weight: bold; color:#6D6E70;"><strong>Sin Pack</strong></td>
                                                      <!--<t t-if="move.procurement_id.sale_line_id.discount == float(0)">
                                                          <td class="text-center"><span t-esc="move.order_price_unit"/></td>
                                                      </t>
                                                      <t t-if="move.procurement_id.sale_line_id.discount != float(0)">
                                                          <td class="text-center"><span t-esc="move.order_price_unit/(move.procurement_id.sale_line_id.discount/100)"/></td>
                                                      </t>-->
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                  </tr>
                                                  <td><span t-field="move.product_id"/></td>
                                                  <td style="font-size:10px"><span t-field="move.product_id.product_tmpl_id.description_sale"/></td>
                                                  <td class="text-center"><span t-esc="'%.0f'% move.product_uom_qty"/></td>
                                                  <td class="text-center"><span t-field="move.procurement_id.sale_line_id.price_unit" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;monetary_widget&quot;}"/></td>
                                                  <td class="text-center"><span t-field="move.procurement_id.sale_line_id.discount"></span> %</td>
                                                  <td class="text-center"><span t-field="move.order_price_unit" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;monetary_widget&quot;}"/></td>
                                                  <td class="text-center"><span t-field="move.price_subtotal" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;monetary_widget&quot;}"/></td>

                                              </t>
                                          </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="page" t-if="o.partner_id.parent_id.valued_picking == False or o.partner_id.valued_picking == False or o.picking_type_id.code != 'outgoing' or o.has_packs"  >
                            <div class="row">
                                <table class="table table-condensed" style="font-size:12px; margin-top: 5%;">
                                     <thead>
                                      <tr style="background-color:#A61D34; color:white;">
                                          <th width="15%" style="vertical-align:middle;"><strong>Reference</strong></th>
                                          <th width="40%" style="vertical-align:middle;"><strong>Description</strong></th>
                                          <th width="7%" class="text-center" style="vertical-align:middle;"><strong>Quantity</strong></th>
                                          <th width="10%" class="text-center" style="vertical-align:middle;"><strong>Unit Price</strong></th>
                                          <th width="8%" class="text-center" style="vertical-align:middle;"><strong>Discount</strong></th>
                                          <th width="10%" class="text-center" style="vertical-align:middle;"><strong>Unit Cost</strong></th>
                                          <th width="10%" class="text-center" style="vertical-align:middle;"><strong>Amount</strong></th>
                                      </tr>
                                    </thead>
                                    <tbody style="color:6D6E70;">
                                        <t t-set="last_pack" t-value="empty"/>
                                        <t t-set="controller" t-value="0"/>
                                        <t t-foreach="o.move_lines" t-as="move">
                                              <t t-if="move.sale_line_id.pack_components is True">
                                                  <tr>
                                                          <tr t-if="last_pack != move.sale_line_id.pack_components">
                                                              <t t-set="last_pack" t-value="move.procurement_id.sale_line_id.pack_parent_line_id.product_id"/>
                                                              <t t-set="qty" t-value="move.procurement_id.sale_line_id.pack_parent_line_id.product_uom_qty"/>
                                                              <td colspan="2" style="font-size:14px; font-weight: bold; color:#6D6E70;">Pack: <strong t-field="move.procurement_id.sale_line_id.pack_parent_line_id.product_id"/> (<strong t-esc="'%.0f' %  qty"/>)</td>
                                                              <!--<t t-if="move.procurement_id.sale_line_id.discount == float(0)">
                                                                  <td class="text-center"><span t-esc="move.order_price_unit"/></td>
                                                              </t>
                                                              <t t-if="move.procurement_id.sale_line_id.discount != float(0)">
                                                                  <td class="text-center"><span t-esc="move.order_price_unit/(move.procurement_id.sale_line_id.discount/100)"/></td>
                                                              </t>-->
                                                              <td class="text-center"></td>
                                                              <td class="text-center"></td>
                                                              <td class="text-center"></td>
                                                              <td class="text-center"></td>
                                                              <td class="text-center"></td>
                                                          </tr>
                                                      <td><span t-field="move.product_id"/></td>
                                                      <td style="font-size:10px"><span t-field="move.product_id.product_tmpl_id.description_sale"/></td>
                                                      <td class="text-center"><span t-esc="'%.0f'% move.product_uom_qty"/></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                  </tr>
                                              </t>
                                        </t>
                                        <tr t-foreach="o.move_lines" t-as="move">
                                              <t t-if="move.sale_line_id.pack_components is False">
                                                  <tr t-if="controller == 0">
                                                      <t t-set="controller" t-value="1"/>
                                                      <td colspan="2" style="font-size:14px; font-weight: bold; color:#6D6E70;"><strong>Sin Pack</strong></td>
                                                      <!--<t t-if="move.procurement_id.sale_line_id.discount == float(0)">
                                                          <td class="text-center"><span t-esc="move.order_price_unit"/></td>
                                                      </t>
                                                      <t t-if="move.procurement_id.sale_line_id.discount != float(0)">
                                                          <td class="text-center"><span t-esc="move.order_price_unit/(move.procurement_id.sale_line_id.discount/100)"/></td>
                                                      </t>-->
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                      <td class="text-center"></td>
                                                  </tr>
                                                  <td><span t-field="move.product_id"/></td>
                                                  <td style="font-size:10px"><span t-field="move.product_id.product_tmpl_id.description_sale"/></td>
                                                  <td class="text-center"><span t-esc="'%.0f'% move.product_uom_qty"/></td>
                                                  <td class="text-center"></td>
                                                  <td class="text-center"></td>
                                                  <td class="text-center"></td>
                                                  <td class="text-center"></td>
                                              </t>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                </t>
             </t>
         </t>
    </template>

    <template id="report_picking_custom_v">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="custom_report_link.report_picking_custom_data_v" t-lang="doc.partner_id.lang" />
            </t>
        </t>
    </template>


    <report
        id="report_picking_custo_action"
        string="Albarán 11v"
        model="stock.picking"
        report_type="qweb-pdf"
        file="custom_report_link.report_picking_custom_v"
        name="custom_report_link.report_picking_custom_v"
    />

    <record id="report_picking_custo_action" model="ir.actions.report">
        <field name="paperformat_id" ref="custom_report_link.paperformat_picking"/>
    </record>

     <record id="stock_custom.action_report_picking_attachments" model="ir.actions.report">
        <field name="paperformat_id" ref="custom_report_link.paperformat_picking"/>
    </record>

</odoo>
